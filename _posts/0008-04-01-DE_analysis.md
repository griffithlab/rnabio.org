---
feature_text: |
  ## RNA-seq Bioinformatics
  Introduction to bioinformatics for RNA sequence analysis
title: Differential expression analysis
categories:
    - Module-08-scRNA
feature_image: "assets/genvis-dna-bg_optimized_v1a.png"
date: 0008-04-01
---

***

In this section we will use the previously generated Seurat object that has gone through the various preprocessing steps, clustering, and celltyping, and use it for gene expression and differential expression analyses. Since we know that the tumor cells should be epithelial cells, we can begin by trying to identify epithelial cells in our data using expression of Epcam as a marker. We can then compare this against the celltype annotations determined by us in the previous section. Subsequently, we will carry out a differential expression analysis within the Epcam positive population(s). 

***

### Gene expression analysis

Read-in the saved seurat object from the previous step if it is not already loaded in your current R session.

```R
library(Seurat)
library(dplyr)
library(EnhancedVolcano)
library(presto)
merged <- readRDS('processed_object_0409.rds')
```

*TODO we may take care of the step below in a previous section*

As of now the various replicates are in their own layers. They need to be merged into 1 single layer for further analysis. Also add (draft) SingleR labels to the object.

```R
library(celldex)
library(SingleR)

merged
merged <- JoinLayers(merged)
merged

#load singler immgen reference
ref_immgen <- celldex::ImmGenData()
#generate predictions for our seurat object
predictions_main = SingleR(test = GetAssayData(merged), 
                      ref = ref_immgen,
                      labels = ref_immgen$label.main)

predictions_fine = SingleR(test = GetAssayData(merged), 
                           ref = ref_immgen,
                           labels = ref_immgen$label.fine)

#add main labels to object
merged[['immgen_singler_main']] = rep('NA', ncol(merged))
merged$immgen_singler_main[rownames(predictions_main)] = predictions_main$labels

#add fine labels to object
merged[['immgen_singler_fine']] = rep('NA', ncol(merged))
merged$immgen_singler_fine[rownames(predictions_fine)] = predictions_fine$labels


```

Compare the number of layers present before and after merging. This is an important step because many of the DE functions use the log normalized data (held in the `data` layer instead of the data kept in the `scale.data` layer.  

Use Seurat's `FeaturePlot` function to color each cell by its Epcam expression on a UMAP.
FeaturePlot requires at least 2 arguments- the seurat object, and the 'feature' you want to plot. The feature can be a gene, PC scores, any of the metadata columns, etc.). To customize the `FeaturePlot`, please refer to Seurat's documentation [here](https://satijalab.org/seurat/reference/featureplot)

```R
FeaturePlot(merged, features = 'Epcam')
```

While there are some Epcam positive cells scattered about, there appear to be 2 distinct groups of cells at the top of the UMAP that we may be able to pull apart as potentially being malignant cells. 
There are a few different ways to go about identifying what those clusters are. We can start by trying to use the `DimPlot` function from before along with the `FeaturePlot` function.

```R
DimPlot(merged, group.by = 'seurat_clusters_res0.8', label = TRUE) + 
FeaturePlot(merged, features = 'Epcam') + 
DimPlot(merged, group.by = 'immgen_singler_main', label = TRUE)
```

While the plots generated by the above commands make it pretty clear that clusters of interest are clusters 10 and 12, sometimes it is trickier to determine which cluster we are interested in solely from the UMAP as the clusters may be overlapping. In this case, a violin plot `VlnPlot` may be more helpful. Similar to `FeaturePlot`, `VlnPlot` also takes the Seurat object and `features` as input. We will also provide a `group.by` argument that determines the x-axis groupings of the cells.  
To learn more about customizing a Violin plot, please refer to the [Seurat documentation](https://satijalab.org/seurat/reference/vlnplot)

```R
VlnPlot(merged, group.by = 'seurat_clusters_res0.8', features = 'Epcam')
```

Thus we were able to confirm that clusters 10 and 12 have the highest expression of Epcam. However, it is interesting that they are split into 2 clusters. Let's use differential expression analysis to determine how these clusters differ from each other.

### Differential expression

We can begin by restricting the Seurat object to the cells we are interested in. We will do so using Seurat's `subset` function, that allows us to create an object that is filtered to any values of interest in the metadata column. However, we first need to set the default identity of the Seurat object to the metadata column we want to use for the subset, and we can do so using the `SetIdent` function. After subsetting the object, we can plot the original object and subsetted object side-by-side to ensure the subsetting happened as expected.We can also count the number of cells of each type to confirm the same.

```R
merged <- SetIdent(merged, value = 'seurat_clusters_res0.8')
merged_epithelial <- subset(merged, idents = c('10', '12'))

#confirm that we have subset the object as expected visually using a UMAP
DimPlot(merged, group.by = 'seurat_clusters_res0.8', label = TRUE) + 
DimPlot(merged_epithelial, group.by = 'seurat_clusters_res0.8', label = TRUE)

#confirm that we have subset the object as expected by looking at the individual cell counts
table(merged$seurat_clusters_res0.8)
table(merged_epithelial$seurat_clusters_res0.8)
```

Now we will use Seurat's `FindMarkers` function to carry out a differential expression analysis between both groups. `FindMarkers` also requires that we use `SetIdent` to change the default Ident to the metadata column we want to make a comparison within.
More information about `FindMarkers` is available [here](https://satijalab.org/seurat/reference/findmarkers)
Note that here we use `FindMarkers` to compare clusters 10 and 12. The default syntax of `FindMarkers` requires that we provide each group of cells as `ident.1` and `ident.2`. The output of `FindMarkers` is a table with each gene that is differentially expressed and includes a column for the corresponding log2FC. The direction of the log2FC is of `ident.1` with respect to `ident.2`. Therefore, genes upregulated in `ident.1` have positive log2FC, while those downregulated in `ident.1` have negative log2FC.  

```R
merged_epithelial <- SetIdent(merged_epithelial, value = "seurat_clusters_res0.8")
epithelial_de <- FindMarkers(merged_epithelial, ident.1 = "10", ident.2 = "12", min.pct=0.25) #how cluster 10 changes wrt cluster 12
```
On opening `epithelial_de` in your RStudio session, you'll see that it is a dataframe with the genes as rownames, and the columns- `p_val`, `avg_log2FC`, `pct.1`, `pct.2`, `p_val_adj`. The p-values are dependent on the test used while running `FindMarkers`, and the adjusted p-value is based on the bonferroni correction test. `pct.1` and `pct.2` are the percentages of cells where the gene is detected in the `ident.1` and `ident.2` groups. 

Next we can subset this dataframe to only include genes that are significantly differentially expressed, and then further subset the significant genes only dataframe to include the top 20 genes that have the highest log2FC. 

```R
#restrict differentially expressed genes to those with an adjusted p-value less than 0.001 
epithelial_de_sig <- epithelial_de[epithelial_de$p_val_adj < 0.001,]

#get the top 20 genes by fold change
epithelial_de_sig %>%
  top_n(n = 20, wt = abs(avg_log2FC)) -> epithelial_de_sig_top20
```

`epithelial_de_sig_top20` is a dataframe that is restricted to the top20 most differentially expressed genes by log2FC.

There are a few different ways we can visualize the differentially expressed genes. We'll start by use some of the inbuilt Seurat plotting functions and a volcano plot.

```R
#get list of top 20 DE genes for ease
epithelial_de_sig_top20_genes <- rownames(epithelial_de_sig_top20)

#plot all 20 genes in violin plots
VlnPlot(merged_epithelial, features = epithelial_de_sig_top20_genes, group.by = 'seurat_clusters_res0.8', ncol = 5, pt.size = 0)

#plot all 20 genes in UMAP plots
FeaturePlot(merged_epithelial, features = epithelial_de_sig_top20_genes, ncol = 5)

#plot all 20 genes in a DotPlot
DotPlot(merged_epithelial, features = epithelial_de_sig_top20_genes, group.by = 'seurat_clusters_res0.8') + RotatedAxis()

#plot all differentially expressed genes in a volcano plot
volcano_plot <- EnhancedVolcano(epithelial_de,
                                lab = rownames(epithelial_de),
                                x = 'avg_log2FC',
                                y = 'p_val_adj',
                                title = 'Adeno wrt DNA',
                                pCutoff = 0.05,
                                FCcutoff = 0.5,
                                pointSize = 3.0,
                                labSize = 5.0,
                                colAlpha = 0.3)








## Differential expression analysis
